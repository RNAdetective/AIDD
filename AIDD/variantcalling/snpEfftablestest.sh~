#!/usr/bin/env bash
main_function() {
export PATH=$PATH:/home/user/AIDD/AIDD_tools/bin
INPUT=/media/sf_AIDD/PHENO_DATA2.csv
OLDIFS=$IFS
IFS=,
[ ! -f $INPUT ] && { echo "$INPUT file not found"; exit 99; }
while read  x run condition sample t_name2
do
  ## delete old headers
  sed -i '1,2d' /media/sf_AIDD/raw_data/snpEff/snpEff"$run".genes.txt
  ## convert txt to csv
  sed 's/ \+/,/g' /media/sf_AIDD/raw_data/snpEff/snpEff"$run".genes.txt > /media/sf_AIDD/raw_data/snpEff/"$x"genes.csv
  ## only print needed columns
  ## WORD="yourwordhere"; head -n1 filename.txt | tr "\t" "\n" | grep -n $WORD
  awk '{print $2, $3, $5, $6, $7}' /media/sf_AIDD/raw_data/snpEff/"$x"genes.csv > /media/sf_AIDD/raw_data/snpEff/"$x"impact.txt
  ## add correct column names
  sed -i '1igene_id transcript_id high_impact low_impact moderate_impact' /media/sf_AIDD/raw_data/snpEff/"$x"impact.txt
  ##split one column into many
  sed 's/ \+/,/g' /media/sf_AIDD/raw_data/snpEff/"$x"impact.txt > /media/sf_AIDD/raw_data/snpEff/"$x"impact.csv
  ##make condition folders
for i in gene transcript ; do
for j in high moderate ; do
  awk -f /home/user/AIDD/bashScripts/variantcalling/SplitColName.awk -v c=""$i"_id, "$j"_impact" /media/sf_AIDD/raw_data/snpEff/"$x"impact.csv > /media/sf_AIDD/Results/variant_calling/haplotype/"$i"/"$j"_impact/"$x""$j".txt
  sed 's/ \+/,/g' /media/sf_AIDD/Results/variant_calling/haplotype/"$i"/"$j"_impact/"$x""$j".txt > /media/sf_AIDD/Results/variant_calling/haplotype/"$i"/"$j"_impact/"$x""$j".csv
  #grep -v -e "^0$" /media/sf_AIDD/Results/variant_calling/haplotype/"$i"/"$j"_impact/"$x""$condition""$j".csv
  sed -i '1d' /media/sf_AIDD/Results/variant_calling/haplotype/"$i"/"$j"_impact/"$x""$j".csv 
  sed -i '1i'$i'_id, '$x'' /media/sf_AIDD/Results/variant_calling/haplotype/"$i"/"$j"_impact/"$x""$j".csv
  ## sort then remove zeros and add
  sort -k2 -nr /media/sf_AIDD/Results/variant_calling/haplotype/"$i"/"$j"_impact/"$x""$j".csv > /media/sf_AIDD/Results/variant_calling/haplotype/"$i"/"$j"_impact/"$x""$j"sorted.csv
  mkdir /media/sf_AIDD/Results/variant_calling/haplotype/"$i"/"$j"_impact/"$condition"/
  mv /media/sf_AIDD/Results/variant_calling/haplotype/"$i"/"$j"_impact/"$condition"*.csv /media/sf_AIDD/Results/variant_calling/haplotype/"$i"/"$j"_impact/"$condition"/
done
done


done < $INPUT
IFS=$OLDIFS
}
main_function 2>&1 | tee -a /media/sf_AIDD/quality_control/logs/snpEfftables.log
